<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Nhận diện Khuôn mặt</title>
    <!-- Sử dụng Tailwind CSS để làm giao diện đẹp và hiện đại -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải thư viện face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        /* CSS tùy chỉnh để giao diện đẹp hơn */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Nền tối */
            color: #e5e7eb;
        }
        .container {
            max-width: 1024px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: #1f2937;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #374151;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #2563eb;
        }
        .btn:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
        }
        #video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: auto;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #video, #canvas-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #image-container {
            position: relative;
            max-width: 640px;
            margin: auto;
        }
        #uploaded-image, #canvas-image {
            max-width: 100%;
            border-radius: 0.5rem;
        }
        #canvas-image {
             position: absolute;
             top: 0;
             left: 0;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">Ứng dụng Nhận diện Khuôn mặt</h1>
            <p class="text-lg text-gray-400 mt-2">Xây dựng CSDL, nhận diện qua Webcam hoặc tải ảnh lên.</p>
        </header>

        <!-- Vùng trạng thái và tải model -->
        <div id="status-card" class="card flex items-center justify-center space-x-4">
            <div id="loader" class="loader"></div>
            <p id="status-text" class="text-lg font-medium">Đang tải các mô hình AI... Vui lòng chờ.</p>
        </div>

        <!-- Bước 1: Xây dựng Cơ sở dữ liệu -->
        <div id="db-card" class="card hidden">
            <h2 class="text-2xl font-bold mb-4">Bước 1: Xây dựng Cơ sở dữ liệu (CSDL)</h2>
            <p class="mb-4 text-gray-400">Tải lên các file ảnh chân dung (ví dụ: folder 24IT của bạn). Tên người sẽ được lấy từ tên file. Chọn tất cả các file cùng lúc.</p>
            <input type="file" id="image-upload-db" multiple accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600"/>
            <button id="build-db-btn" class="btn mt-4">Bắt đầu xây dựng CSDL</button>
            <div id="db-log" class="mt-4 text-sm text-gray-400 bg-gray-800 p-3 rounded-md max-h-40 overflow-y-auto"></div>
        </div>

        <!-- Bước 2: Chọn phương thức nhận diện -->
        <div id="main-controls" class="card text-center hidden">
            <h2 class="text-2xl font-bold mb-4">Bước 2: Chọn phương thức Nhận diện</h2>
            <p class="mb-6 text-gray-400">CSDL đã sẵn sàng! Bây giờ bạn có thể nhận diện qua Webcam hoặc tải ảnh lên.</p>
            <div class="flex justify-center space-x-4">
                <button id="webcam-btn" class="btn">Bật Webcam</button>
                <button id="upload-btn" class="btn">Tải ảnh lên</button>
            </div>
        </div>

        <!-- Vùng hiển thị Webcam -->
        <div id="webcam-section" class="card hidden">
            <div id="video-container" style="padding-top: 75%;"> <!-- Tỷ lệ 4:3 -->
                <video id="video" autoplay muted playsinline></video>
                <canvas id="canvas-video"></canvas>
            </div>
            <div class="text-center mt-4">
                 <button id="stop-webcam-btn" class="btn bg-red-600 hover:bg-red-700">Tắt Webcam</button>
            </div>
        </div>

        <!-- Vùng hiển thị ảnh Upload -->
        <div id="image-section" class="card hidden">
             <div id="drop-zone" class="flex items-center justify-center w-full h-64 border-2 border-dashed border-gray-600 rounded-lg cursor-pointer hover:bg-gray-800">
                <div class="text-center">
                    <p class="text-gray-400">Kéo và thả ảnh vào đây</p>
                    <p class="text-sm text-gray-500">hoặc nhấn để chọn file</p>
                </div>
            </div>
            <input type="file" id="image-upload-single" class="hidden" accept="image/*">
            <div id="image-container" class="mt-4">
                <img id="uploaded-image" class="hidden"/>
                <canvas id="canvas-image"></canvas>
            </div>
        </div>

    </div>

    <script>
        // --- KHAI BÁO CÁC BIẾN GIAO DIỆN ---
        const statusCard = document.getElementById('status-card');
        const statusText = document.getElementById('status-text');
        const loader = document.getElementById('loader');
        const dbCard = document.getElementById('db-card');
        const mainControls = document.getElementById('main-controls');
        const webcamSection = document.getElementById('webcam-section');
        const imageSection = document.getElementById('image-section');
        const video = document.getElementById('video');
        const buildDbBtn = document.getElementById('build-db-btn');
        const dbLog = document.getElementById('db-log');
        const webcamBtn = document.getElementById('webcam-btn');
        const stopWebcamBtn = document.getElementById('stop-webcam-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const dropZone = document.getElementById('drop-zone');
        const imageUploadSingle = document.getElementById('image-upload-single');
        const uploadedImage = document.getElementById('uploaded-image');

        let labeledFaceDescriptors = null;
        let faceMatcher = null;
        let videoInterval = null;
        let stream = null;

        // --- HÀM KHỞI TẠO VÀ TẢI MODEL ---
        async function loadModels() {
            // Đường dẫn đến các model đã được huấn luyện sẵn của face-api.js
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            try {
                // Tải các model cần thiết cho việc nhận diện
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                
                // Cập nhật giao diện sau khi tải xong
                statusText.textContent = 'Các mô hình đã sẵn sàng!';
                loader.style.display = 'none';
                dbCard.classList.remove('hidden');
            } catch (error) {
                statusText.textContent = 'Lỗi khi tải model. Vui lòng kiểm tra kết nối mạng và thử lại.';
                console.error("Model loading error:", error);
            }
        }

        // --- HÀM XỬ LÝ CƠ SỞ DỮ LIỆU ---
        async function buildFaceDatabase() {
            const imageUploadDb = document.getElementById('image-upload-db');
            if (imageUploadDb.files.length === 0) {
                dbLog.innerHTML = '<span class="text-red-400">Vui lòng chọn ít nhất một ảnh.</span>';
                return;
            }

            buildDbBtn.disabled = true;
            dbLog.innerHTML = 'Bắt đầu xử lý...<br>';
            
            // tinyFaceDetector nhanh hơn, phù hợp cho nhiều ảnh
            const detectorOptions = new faceapi.TinyFaceDetectorOptions();

            const descriptors = [];
            for (let i = 0; i < imageUploadDb.files.length; i++) {
                const file = imageUploadDb.files[i];
                // Lấy tên từ tên file (ví dụ: Elon_Musk.jpg -> Elon Musk)
                const name = file.name.split('.')[0].replace(/_/g, ' ').replace(/\d/g, '').trim();
                dbLog.innerHTML += `Đang xử lý ${file.name}... `;

                const img = await faceapi.bufferToImage(file);
                // Phát hiện khuôn mặt, trích xuất đặc trưng
                const detection = await faceapi.detectSingleFace(img, detectorOptions)
                                             .withFaceLandmarks()
                                             .withFaceDescriptor();
                
                if (detection) {
                    descriptors.push(new faceapi.LabeledFaceDescriptors(name, [detection.descriptor]));
                    dbLog.innerHTML += '<span class="text-green-400">Thành công!</span><br>';
                } else {
                    dbLog.innerHTML += '<span class="text-yellow-400">Không tìm thấy khuôn mặt.</span><br>';
                }
            }
            
            labeledFaceDescriptors = descriptors;
            // Tạo FaceMatcher để so sánh khuôn mặt
            faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.5); // 0.5 là ngưỡng khoảng cách
            
            dbLog.innerHTML += '<b>CSDL đã được xây dựng thành công!</b>';
            buildDbBtn.disabled = false;
            dbCard.classList.add('hidden'); // Ẩn card CSDL
            mainControls.classList.remove('hidden'); // Hiển thị các nút điều khiển chính
        }

        // --- HÀM XỬ LÝ WEBCAM ---
        async function startWebcam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
                mainControls.classList.add('hidden');
                webcamSection.classList.remove('hidden');
            } catch (err) {
                console.error("Webcam error:", err);
                alert("Không thể truy cập webcam. Vui lòng cấp quyền cho trình duyệt.");
            }
        }

        function stopWebcam() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            clearInterval(videoInterval);
            video.srcObject = null;
            const canvas = document.getElementById('canvas-video');
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            webcamSection.classList.add('hidden');
            mainControls.classList.remove('hidden');
        }

        video.addEventListener('play', () => {
            const canvas = faceapi.createCanvasFromMedia(video);
            document.getElementById('video-container').append(canvas);
            canvas.id = 'canvas-video'; // Gán lại ID để style CSS hoạt động
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);

            videoInterval = setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                                                .withFaceLandmarks()
                                                .withFaceDescriptors();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                
                const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));
                results.forEach((result, i) => {
                    const box = resizedDetections[i].detection.box;
                    const drawBox = new faceapi.draw.DrawBox(box, { label: result.toString() });
                    drawBox.draw(canvas);
                });
            }, 100); // Nhận diện mỗi 100ms
        });

        // --- HÀM XỬ LÝ UPLOAD ẢNH ---
        function handleImageUpload(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = e => {
                uploadedImage.src = e.target.result;
                uploadedImage.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
            
            mainControls.classList.add('hidden');
            imageSection.classList.remove('hidden');
        }
        
        uploadedImage.onload = async () => {
            const canvas = faceapi.createCanvasFromMedia(uploadedImage);
            document.getElementById('image-container').append(canvas);
            canvas.id = 'canvas-image'; // Gán lại ID
            const displaySize = { width: uploadedImage.width, height: uploadedImage.height };
            faceapi.matchDimensions(canvas, displaySize);

            const detections = await faceapi.detectAllFaces(uploadedImage)
                                            .withFaceLandmarks()
                                            .withFaceDescriptors();
            const resizedDetections = faceapi.resizeResults(detections, displaySize);
            
            const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));
            results.forEach((result, i) => {
                const box = resizedDetections[i].detection.box;
                const drawBox = new faceapi.draw.DrawBox(box, { label: result.toString() });
                drawBox.draw(canvas);
            });
        };

        // --- GÁN SỰ KIỆN CHO CÁC NÚT BẤM VÀ VÙNG KÉO THẢ ---
        window.onload = loadModels;
        buildDbBtn.addEventListener('click', buildFaceDatabase);
        webcamBtn.addEventListener('click', startWebcam);
        stopWebcamBtn.addEventListener('click', stopWebcam);
        uploadBtn.addEventListener('click', () => {
             mainControls.classList.add('hidden');
             imageSection.classList.remove('hidden');
        });

        // Xử lý kéo thả
        dropZone.addEventListener('click', () => imageUploadSingle.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('bg-gray-800');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('bg-gray-800');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-gray-800');
            if (e.dataTransfer.files.length) {
                imageUploadSingle.files = e.dataTransfer.files;
                handleImageUpload(e.dataTransfer.files[0]);
            }
        });
        imageUploadSingle.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleImageUpload(e.target.files[0]);
            }
        });
    </script>
</body>
</html>
